<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="darkreader-lock">
<title>GScript.dev</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="css/shared.css?v=5">
<style>
  body{margin:0;padding:0;min-height:100vh;background:transparent;color:#fff;overflow-x:hidden;}
  .container{transition:opacity 0.4s ease;position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;min-height:100vh;overflow-x:hidden;}
  .container.fade-out{opacity:0;}
  .monaco-editor-container .view-line span { text-shadow: 0 0 2px rgba(0,0,0,0.8) !important; }
  .monaco-editor-container .monaco-editor-background { background-color: rgba(40, 42, 54, 0.85) !important; }
  .monaco-editor-container .monaco-editor { background-color: transparent !important; }
</style>
</head>
<body>
<div class="contain-bg2" id="background"></div>
<div id="root"></div>

<script src="js/react.production.min.js" crossorigin></script>
<script src="js/react-dom.production.min.js" crossorigin></script>
<script src="js/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@floating-ui/core@1.6.8"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.6.12"></script>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const ClickSpark = ({
  sparkColor = '#40ff40',
  sparkSize = 10,
  sparkRadius = 15,
  sparkCount = 8,
  duration = 400,
  easing = 'ease-out',
  extraScale = 1.0,
  children,
  onClick
}) => {
  const canvasRef = useRef(null);
  const sparksRef = useRef([]);
  const startTimeRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const parent = canvas.parentElement;
    if (!parent) return;

    let resizeTimeout;

    const resizeCanvas = () => {
      const { width, height } = parent.getBoundingClientRect();
      if (canvas.width !== width || canvas.height !== height) {
        canvas.width = width;
        canvas.height = height;
      }
    };

    const handleResize = () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resizeCanvas, 100);
    };

    const ro = new ResizeObserver(handleResize);
    ro.observe(parent);

    resizeCanvas();

    return () => {
      ro.disconnect();
      clearTimeout(resizeTimeout);
    };
  }, []);

  const easeFunc = useCallback(
    t => {
      switch (easing) {
        case 'linear':
          return t;
        case 'ease-in':
          return t * t;
        case 'ease-in-out':
          return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
        default:
          return t * (2 - t);
      }
    },
    [easing]
  );

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    let animationId;

    const draw = timestamp => {
      if (!startTimeRef.current) {
        startTimeRef.current = timestamp;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      sparksRef.current = sparksRef.current.filter(spark => {
        const elapsed = timestamp - spark.startTime;
        if (elapsed >= duration) {
          return false;
        }

        const progress = elapsed / duration;
        const eased = easeFunc(progress);

        const distance = eased * sparkRadius * extraScale;
        const lineLength = sparkSize * (1 - eased);

        const x1 = spark.x + distance * Math.cos(spark.angle);
        const y1 = spark.y + distance * Math.sin(spark.angle);
        const x2 = spark.x + (distance + lineLength) * Math.cos(spark.angle);
        const y2 = spark.y + (distance + lineLength) * Math.sin(spark.angle);

        ctx.strokeStyle = sparkColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        return true;
      });

      animationId = requestAnimationFrame(draw);
    };

    animationId = requestAnimationFrame(draw);

    return () => {
      cancelAnimationFrame(animationId);
    };
  }, [sparkColor, sparkSize, sparkRadius, sparkCount, duration, easeFunc, extraScale]);

  const handleClick = e => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const now = performance.now();
    const newSparks = Array.from({ length: sparkCount }, (_, i) => ({
      x,
      y,
      angle: (2 * Math.PI * i) / sparkCount,
      startTime: now
    }));

    sparksRef.current.push(...newSparks);
  };

  const handleChildClick = (e) => {
    if (onClick) {
      onClick(e);
    }
  };

  return (
    <div
      style={{
        position: 'relative',
        width: '100%',
        height: '100%',
        display: 'inline-block'
      }}
      onClick={handleClick}
    >
      <canvas
        ref={canvasRef}
        style={{
          width: '100%',
          height: '100%',
          display: 'block',
          userSelect: 'none',
          position: 'absolute',
          top: 0,
          left: 0,
          pointerEvents: 'none',
          zIndex: 1
        }}
      />
      {children}
    </div>
  );
};

const data = {
  documentation: [
    { icon: 'fas fa-book', text: 'GScript Docs (Graal Bible)', href: 'https://graalonline.net/Creation/Dev/GScript' },
    { icon: 'fas fa-book-open', text: 'Graal Bible Mirror', href: 'https://wiki.gscript.dev/Creation/Dev/GScript' },
    { icon: 'fas fa-file-code', text: 'GScript Definitions', href: 'https://docs.gscript.dev' },
    { icon: 'fas fa-file-code', text: 'GS2 Docs (Ruan)', href: 'https://gsdocs.ruanfergui.com.br/' },
    { icon: 'fas fa-cube', text: 'Unity/Quattro3D Docs', href: 'https://unity.gscript.dev/' },
    { icon: 'fas fa-chart-line', text: 'Graal Server Statistics', href: 'https://stats.gscript.dev/' }
  ],
  tools: [
    {
      icon: 'fas fa-terminal',
      text: 'RemoteControl2',
      submenu: [
        { icon: 'fab fa-windows', text: 'RC2 (Windows)', href: 'https://gscript.dev/RemoteControl2_win8+.zip' },
        { icon: 'fab fa-linux', text: 'RC2 (Linux)', href: 'https://gscript.dev/rc2.AppImage' }
      ]
    },
    {
      icon: 'fas fa-terminal',
      text: 'RemoteControl3',
      submenu: [
        { icon: 'fab fa-windows', text: 'RC3 (Win)', href: 'https://gscript.dev/rc_win.zip' },
        { icon: 'fab fa-windows', text: 'RC3 (Win) (Dark)', href: 'https://gscript.dev/rc3_win_dark.zip' },
        { icon: 'fab fa-apple', text: 'RC3 (Mac)', href: 'https://gscript.dev/rc_mac.zip' },
        { icon: 'fab fa-apple', text: 'RC3 (Mac) (Dark)', href: 'https://gscript.dev/rc_mac_dark.zip' }
      ]
    },
    { icon: 'fas fa-server', text: 'GS2 Emulator (Web)', href: 'https://gs2.gscript.dev/' },
    {
      icon: 'fas fa-magic',
      text: 'Beautifiers',
      submenu: [
        { icon: 'fas fa-magic', text: '#gscript', href: '/?beautify' },
        { icon: 'fas fa-wand-magic-sparkles', text: 'FP4', href: 'https://www.fp4.ca/gs2beautifier/' }
      ]
    },
    { icon: 'fas fa-paste', text: 'Gscript Pastebin', href: 'https://paste.gscript.dev' },
    { icon: 'fas fa-database', text: 'GS2 Definitions (Bot/LSP Data)', href: 'https://api.gscript.dev/' },
    {
      icon: 'fas fa-code',
      text: 'Sublime Tools',
      submenu: [
        { icon: 'fas fa-code', text: 'Syntax Highlighting (Denveous)', href: 'https://github.com/Denveous/gscript-sublime-hl' },
        { icon: 'fas fa-plug', text: 'LSP (Denveous)', href: 'https://github.com/MorenoLand/Moreno.SublimeLSP' }
      ]
    },
    {
      icon: 'fas fa-code',
      text: 'VSCode Tools',
      submenu: [
        { icon: 'fab fa-microsoft', text: 'Syntax (Maxy)', href: 'https://gscript.dev/graal-language-0.0.1.vsix' },
        { icon: 'fas fa-code', text: 'Highlighting (Ruan)', href: 'https://github.com/RuanFernandes/graalscript-hl' },
        { icon: 'fas fa-plug', text: 'LSP (Ruan)', href: 'https://marketplace.visualstudio.com/items?itemName=ruanfernandes.graalscript-lsp' }
      ]
    },
    {
      icon: 'fas fa-edit',
      text: 'Gani Editor (Web)',
      submenu: [
        { icon: 'fas fa-globe', text: 'Web', href: 'https://gani.gscript.dev' },
        { icon: 'fab fa-github', text: 'Git Mirror', href: 'https://morenoland.github.io/GaniEditorWeb' },
        { icon: 'fas fa-code', text: 'Source', href: 'https://github.com/MorenoLand/GScript.GaniEditor' }
      ]
    },
    {
      icon: 'fas fa-edit',
      text: 'Gani/Level Editor (39ster)',
      submenu: [
        { icon: 'fab fa-github', text: 'Source', href: 'https://github.com/lukegrahamSydney/TilesEditor' },
        { icon: 'fab fa-windows', text: 'Win (x64)', href: 'https://gscript.dev/TilesEditorRelease_win_x64.zip' },
        { icon: 'fab fa-linux', text: 'Linux (x64)', href: 'https://gscript.dev/TilesEditorRelease_linux_x64.zip' }
      ]
    },
    { icon: 'fas fa-shapes', text: 'setshape2/setimgpart Generator', href: 'https://setshape.gscript.dev' },
    { icon: 'fas fa-map', text: 'Gmap Generator', href: 'https://gmap.gscript.dev' },
    {
      icon: 'fas fa-tools',
      text: 'Gonstruct',
      submenu: [
        { icon: 'fab fa-github', text: 'Source', href: 'https://github.com/fry/graal-gonstruct' },
        { icon: 'fab fa-windows', text: 'Win (x64)', href: 'https://gscript.dev/gonstruct-win.zip' },
        { icon: 'fab fa-linux', text: 'Linux (x64)', href: 'https://gscript.dev/gonstruct-linux-x64.zip' }
      ]
    }
  ],
  graphics: [
    { icon: 'fas fa-file-image', text: 'Templates (Rice, old)', href: 'https://gscript.dev/Rice2kTemplates.zip' },
    {
      icon: 'fas fa-file-image',
      text: 'Templates (Coco)',
      submenu: [
        { icon: 'fas fa-download', text: 'Download', href: 'https://gscript.dev/CocoTemplates.zip' },
        { icon: 'fas fa-external-link-alt', text: 'Mirror (Imgur)', href: 'https://imgur.com/a/gtW4S' }
      ]
    },
    { icon: 'fas fa-file-image', text: 'Templates (iClassic)', href: 'https://gscript.dev/PlayerSubmissionTemplates.zip' },
    { icon: 'fas fa-book', text: 'Indexing Guide (Photoshop & GIMP)', href: '/?indexing' }
  ]
};

function DiscordWidget() {
  const [stats, setStats] = useState(null);
  const [widget, setWidget] = useState(null);
  const [error, setError] = useState(false);

  useEffect(() => {
    Promise.all([
      fetch('https://api.moreno.land/api/discord/stats'),
      fetch('https://api.moreno.land/api/discord/users')
    ])
    .then(async ([statsRes, widgetRes]) => {
      const statsData = await statsRes.json();
      const widgetData = await widgetRes.json();
      setStats(statsData);
      setWidget(widgetData);
    })
    .catch(() => setError(true));
  }, []);

  if (error) return <div className="discord-loading">Failed to load Discord data</div>;
  if (!widget || !stats) return <div className="discord-loading">Loading...</div>;

  const membersHtml = widget.members ? widget.members.map(member =>
    <div key={member.username} className="discord-member">
      <img src={member.avatar_url || 'https://cdn.discordapp.com/embed/avatars/0.png'} alt={member.username} className="discord-avatar" />
      <span>{member.username}</span>
    </div>
  ) : null;

  return (
    <div className="discord-custom">
      <div className="discord-header">
        <h3>#gscript Community</h3>
        <p>{stats.online || widget.presence_count || 0} online / {stats.total || '?'} total</p>
      </div>
      {membersHtml && <div className="discord-members">{membersHtml}</div>}
      <a href={widget.instant_invite || 'https://discord.gscript.dev'} target="_blank">Join Discord</a>
    </div>
  );
}

const tutorials = {
  photoshop: `
## Tutorial: Indexing bodies or other images for Graal (Using Photoshop 6.0)

When working with default body images in Graal, you might think you need to use specific color indexes to create a body. However, that's not the case! Graal relies on a palette table and the order of colors within it. The first seven color indexes are reserved for the default Graal coloring system:

- **0:** Outline
- **1:** Belt
- **2:** Transparency
- **3:** Shoes
- **4:** Sleeves
- **5:** Skin
- **6:** Coat

If you create a body without considering these indexes, you might find that your image isn't transparent or that some colors are incorrect. This happens because when you index an image, it assigns used colors to a table. If your body uses colors assigned to the first seven indexes, Graal will treat them as recolorable. Additionally, Graal uses a palette index for transparency instead of traditional transparency methods.

#### 1. Index Your Image
In this tutorial, I will demonstrate how to work with your palette table to either utilize Graal's recoloring system or avoid it altogether. Let's start with **body.png**. Begin by indexing your image:

![Indexing Image](/gfx/pstutorial/bodytut1.PNG)

#### 2. Create a Custom Palette
Next, you want to create a custom palette:

![Custom Palette](/gfx/pstutorial/bodytut2.PNG)

#### 3. Assign Colors to the Palette
You have two options here:

- If you want to use Graal's default body coloring system, assign colors to the palette as outlined above.
- If you prefer not to have your body recolored, fill the first seven boxes with colors that your body does not use. Remember, the third color must match the color you want to be transparent.

![Assigning Colors](/gfx/pstutorial/bodytut3.PNG)

#### 4. Selecting Colors
To select colors, click on the first box. Your mouse will change to an eyedropper when you hover over your image, allowing you to easily select the desired color:

![Selecting Colors](/gfx/pstutorial/bodytut4.PNG)

#### 5. Filling the Palette with Filler Colors
If you want to use your own colors without being limited by Graal's recoloring system, fill the palette with filler colors:

![Filling Palette](/gfx/pstutorial/bodytut5.PNG)

Ensure that all **seven** boxes are filled with colors that are not used in your graphics. For example, I used red (#FF0000) as it was not utilized in my design. You don't need to index the rest of your colors; Photoshop will automatically assign them to the remaining table slots.

#### 6. Saving Your Image
When you're done, click **OK** and then save the image. Chances are it will work fine! Remember, I use Photoshop 6.0; newer versions may have a different setup, and I'm not sure about other programs like GIMP. However, they likely allow you to customize the palette in some way.

**Bonus Tip:** Someone asked if you can combine the two methods to have, say, a purple belt with a body that can change colors. The answer is **YES**! Simply color the belt purple, but in the palette table, the belt box should be filled with a filler color as shown in the second example. This will allow your belt to stay purple while still allowing you to color other parts of the body.
  `,
  gimp: `
## Tutorial: Indexing bodies or other images for Graal (Using GIMP)

Let's learn how to index for Graal! Here I will describe how to properly index bodies to upload them with zero issues. I will be using the program GIMP for PC to do this. The program is free and simple to use! Alright, let's get onto indexing! (Please note that my GIMP set up may visually look different than yours. I am currently using an older version with a different toolbox set up as it is my preference. You should still be able to follow this tutorial just fine though!)

### Step One

Let's get the basics set up. Your body should have a total of **seven** colours. If you are indexing a body with "extensions" or other parts, I will be setting up a guide for that in the future as well. Here are the seven hex code colours you need:

![Outline color black](/gfx/gimptutorial/image-2.webp) The outline colour black: #000000

![Belt color blue](/gfx/gimptutorial/image-3.webp) The belt colour blue: #0000ff

![Background color green](/gfx/gimptutorial/image-4.webp) The background colour green: #008400

![Shoe color dark red](/gfx/gimptutorial/image-5.webp) The shoe colour dark red: #ce1829

![Sleeve color red](/gfx/gimptutorial/image-6.webp) The sleeve colour red: #ff0000

![Glove color orange](/gfx/gimptutorial/image-8.webp) The glove colour orange: #ffad6b

![Coat color white](/gfx/gimptutorial/image-9.webp) The coat colour white: #ffffff

In this tutorial, I will be using the basic default body for simplicity! Let's get started!

### Step Two

You should have your body opened on GIMP with the seven correct colour hexes shown above. Now, let's go to **Image > Mode > Indexed...** in the menus at the top!

![Indexed mode](/gfx/gimptutorial/image-11.png)

You should now be on a screen that looks like this:

![Indexed screen](/gfx/gimptutorial/image-12.png)

Let's click on **Use custom palette**. Then, click on the multi-coloured gradient you see under it! Once you click it, click the **open the palette selection dialogue** option that is circled below.

![Custom palette option](/gfx/gimptutorial/image-13.png)

After clicking that option, it should have opened a large selection of palettes. Ignore these. They are palettes that come pre-built into GIMP. We will be making our own!

![Palette list](/gfx/gimptutorial/image-15.png)

### Step Three

You're doing great so far! Let's continue! Now that we're on the **Palettes** menu, let's click on **create a new palette** circled below.

![Create new palette](/gfx/gimptutorial/image-16.png)

You will be taken to the **Palette Editor** pop up! It will look something like this:

![Palette editor](/gfx/gimptutorial/image-17.png)

You can name your palette in the area that says Untitled! For now I'm going to name mine *Index Colours*, but you can name yours whatever you'd like!

### Step Four

After naming our palette, let's start adding our colours! First thing you wanna do is **create seven entries from the background colour**. Sounds confusing yeah? Don't worry, it's simple!

On the **Palette Editor**, **Ctrl + Click the circled option below** seven times! It is very very important that you **Ctrl + Click** this option instead of regular clicking. Your Palette Editor should look something like this now!

![Seven entries](/gfx/gimptutorial/image-20.png)

Now, let's start adding the colours! **Double-click** on the first square (the one on the far far left) on the Palette Editor. It should open the **Edit Palette Colour** menu! Now, click on the **Eyedropper** tool circled below.

![Eyedropper tool](/gfx/gimptutorial/image-21.png)

Once you've clicked that, we're going to be adding our first colour: the outline colour black! With the Eyedropper tool clicked, click on the outline of your body. It will automatically select that colour for you! Once you click the black outline colour, press **OK**! Your Palette Editor should look like this now:

![First color added](/gfx/gimptutorial/image-22.png)

Now that you know how to use the Eyedropper tool and add a new colour to your palette board, let's add the rest of our needed colours! Here is the order you will need to do it in: **Black, Blue, Green, Dark Red, Red, Orange, White.** Once you have all those colours selected, it should look like this!

![All colors added](/gfx/gimptutorial/image-23.png)

### Step Five

You're doing amazing, we're nearly done! Our next step is to apply our new palette we made to our body! Let's go back to **Image > Mode > Indexed...** in the top menus once again. Click on **Use Custom Palette** and then on the multi-coloured gradient square.

Look through the list of palettes until you see your palette you named and created!

![Select your palette](/gfx/gimptutorial/image-24.png)

Click on your palette! Once you click it, **uncheckmark the Remove unused and duplicate colors from colormap** option right below it, it's very important to uncheck it!

![Uncheck remove unused](/gfx/gimptutorial/image-26.png)

Nice! Now that you've unchecked that option stated above and clicked on your palette for the custom palette, click **Convert**. One more step to complete!

### Step Six

YOUR BODY IS NOW INDEXED! YAY! We have one final step to complete though. Let's head to **File > Export As...** in the menus at the top.

![Export as](/gfx/gimptutorial/image-27.png)

Once on the Export Image pop up, name your file whatever you'd like! Here, I named it "Indexed Body.png". Remember to include the **.png** at the end! Save it to wherever you'd like on your computer.

![Name file](/gfx/gimptutorial/image-29.png)

Now click **Export**! You will get another pop up. On this pop up, make sure you **uncheckmark Save background color**. It is very very important that it is left unchecked!

![Export options](/gfx/gimptutorial/image-30.png)

Now press Export once again! And yay! We're all done with indexing! You're free to upload your body to Graal. There should be no issues if everything was done correctly. If there are questions, you can message me on Graal, my username is always Bryden!

When uploading you also **do not need to set transparency**, for Classic at least!
  `
};

function BeautifyTool() {
  const [language, setLanguage] = useState('graalscript');
  const [stripComments, setStripComments] = useState(true);
  const [beautify, setBeautify] = useState(false);
  const [indentSize, setIndentSize] = useState('2');
  const [copySuccess, setCopySuccess] = useState(false);
  const [monacoReady, setMonacoReady] = useState(false);
  const inputEditorRef = useRef(null);
  const outputEditorRef = useRef(null);
  const inputContainerRef = useRef(null);
  const outputContainerRef = useRef(null);

  const processCode = () => {
    if (!inputEditorRef.current) return;
    const code = inputEditorRef.current.getValue();
    if (!code.trim()) return;
    let processedCode = code;
    if (stripComments) { const lang = { javascript: { singleLine: ['//', '///'], multiLine: [['/*', '*/']], stringDelimiters: ['"', "'", '`'] } }; const l = lang.javascript; const single = l.singleLine || []; const multi = l.multiLine || []; const strings = l.stringDelimiters || ['"', "'"]; const lines = code.split('\n'); const result = []; let inMulti = false; let inString = false; let strDelim = ''; let escaped = false; for (const line of lines) { let res = ''; let j = 0; let hasCode = false; while (j < line.length) { if (inMulti) { if (line.substring(j, j + 2) === '*/') { j += 2; inMulti = false; } else { j++; } continue; } if (inString) { if (line[j] === '\\' && !escaped) { res += line[j]; escaped = true; j++; continue; } if (line.substring(j, j + strDelim.length) === strDelim && !escaped) { res += strDelim; j += strDelim.length; inString = false; hasCode = true; continue; } res += line[j]; if (escaped) escaped = false; j++; continue; } let strMatch = false; for (const delim of strings) { if (line.substring(j, j + delim.length) === delim) { res += delim; j += delim.length; inString = true; strDelim = delim; hasCode = true; strMatch = true; break; } } if (strMatch) continue; let multiMatch = false; for (const [start, end] of multi) { if (line.substring(j, j + start.length) === start) { inMulti = true; j += start.length; if (line.indexOf(end, j) !== -1) { j = line.indexOf(end, j) + end.length; inMulti = false; } multiMatch = true; break; } } if (multiMatch) continue; let singleMatch = false; for (const start of single) { if (line.substring(j, j + start.length) === start) { j = line.length; singleMatch = true; break; } } if (singleMatch) continue; if (!(/^\s*$/.test(line[j]))) hasCode = true; res += line[j]; j++; } if (hasCode || inString) result.push(res); } processedCode = result.join('\n'); }
    if (beautify) { try { processedCode = js_beautify(processedCode, { indent_size: indentSize === 'tab' ? 1 : parseInt(indentSize), indent_char: indentSize === 'tab' ? '\t' : ' ', 'wrap_line_length': 0, 'break_chained_methods': false, 'max_preserve_newlines': 2, 'operator_position': 'before' }); } catch (e) { } }
    if (outputEditorRef.current) outputEditorRef.current.setValue(processedCode);
  };

  const copyToClipboard = () => { if (!outputEditorRef.current) return; navigator.clipboard.writeText(outputEditorRef.current.getValue()).then(() => { setCopySuccess(true); setTimeout(() => setCopySuccess(false), 1500); }); };

  useEffect(() => {
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
      monaco.languages.register({ id: 'graalscript' });
      monaco.languages.setMonarchTokensProvider('graalscript', {
        keywords: [
          'break', 'case', 'continue', 'default', 'do', 'else', 'elseif', 'for', 'if',
          'in', 'return', 'switch', 'while', 'with', 'join', 'leave', 'public', 'private',
          'const', 'enum', 'function', 'new', 'datablock', 'true', 'false', 'nil', 'null',
          'NULL', 'pi', 'timevar2', 'this', 'thiso', 'temp', 'server', 'serverr', 'client',
          'clientr', 'player', 'name'
        ],
        sqlKeywords: [
          'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'CREATE', 'TABLE', 'FROM', 'WHERE',
          'VALUES', 'SET', 'INTO', 'AND', 'OR', 'NOT', 'NULL', 'IS', 'AS', 'ON', 'JOIN',
          'LEFT', 'RIGHT', 'INNER', 'OUTER', 'GROUP', 'BY', 'ORDER', 'LIMIT', 'OFFSET',
          'DISTINCT', 'COUNT', 'AVG', 'SUM', 'MIN', 'MAX', 'PRIMARY', 'KEY', 'DEFAULT', 'INT', 'TEXT'
        ],
        operators: [
          '=', '>', '<', '!', '~', '?', ':', '==', '<=', '>=', '!=',
          '&&', '||', '++', '--', '+', '-', '*', '/', '&', '|', '^', '%',
          '<<', '>>', '>>>', '+=', '-=', '*=', '/=', '&=', '|=', '^=',
          '%=', '<<=', '>>=', '>>>=', '~', '@', '/'
        ],
        symbols: /[=><!~?:&|+\-*\/\^%@]+/,
        escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,
        tokenizer: {
          root: [
            [/\$[a-zA-Z_][a-zA-Z0-9_]*(?:::[a-zA-Z_][a-zA-Z0-9_]*)*/, 'variable.parameter'],
            [/[a-z_$][\w$]*/, {
              cases: {
                '@keywords': 'keyword',
                '@default': 'identifier'
              }
            }],
            { include: '@whitespace' },
            [/[{}()\[\]]/, '@brackets'],
            [/@symbols/, {
              cases: {
                '@operators': 'operator',
                '@default': ''
              }
            }],
            [/\d*\.\d+([eE][\-+]?\d+)?/, 'number.float'],
            [/0[xX][0-9a-fA-F]+/, 'number.hex'],
            [/\b\d+\b/, 'number'],
            [/[;,.]/, 'delimiter'],
            [/"([^"\\]|\\.)*$/, 'string.invalid'],
            [/"/, 'string.sql', '@sqlstring'],
            [/'[^\\']'/, 'string'],
            [/(')(@escapes)(')/, ['string', 'string.escape', 'string']],
            [/'/, 'string.invalid']
          ],
          sqlstring: [
            [/\b(SELECT|INSERT|UPDATE|DELETE|CREATE|TABLE|FROM|WHERE|VALUES|SET|INTO|AND|OR|NOT|NULL|IS|AS|ON|JOIN|LEFT|RIGHT|INNER|OUTER|GROUP|BY|ORDER|LIMIT|OFFSET|DISTINCT|COUNT|AVG|SUM|MIN|MAX|PRIMARY|KEY|DEFAULT|INT|TEXT)\b/, 'keyword.other.sql'],
            [/[^\\"]+/, 'string'],
            [/"/, 'string', '@pop'],
            [/@escapes/, 'string.escape'],
            [/\\./, 'string.escape.invalid']
          ],
          whitespace: [
            [/[ \t\r\n]+/, 'white'],
            [/\/\/.*$/, 'comment'],
            [/^\s*#.*$/, 'comment'],
            [/(?:^|\s)\/\*/, 'comment', '@comment']
          ],
          comment: [
            [/[^\/*]+/, 'comment'],
            [/\/\*/, 'comment', '@push'],
            ['\\*/', 'comment', '@pop'],
            [/[\/*]/, 'comment']
          ],
        }
      });
      monaco.editor.defineTheme('dracula', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          { token: 'comment', foreground: '6272a4', fontStyle: 'italic' },
          { token: 'keyword', foreground: 'ff79c6' },
          { token: 'keyword.other.sql', foreground: 'ff79c6', fontStyle: 'italic' },
          { token: 'string.sql', foreground: 'f1fa8c' },
          { token: 'string', foreground: 'f1fa8c' },
          { token: 'number', foreground: 'bd93f9' },
          { token: 'type', foreground: 'ff79c6' },
          { token: 'identifier', foreground: 'f8f8f2' },
          { token: 'variable.parameter', foreground: 'ffb86c' },
        ],
        colors: {
          'editor.background': '#282a36',
          'editor.foreground': '#f8f8f2',
          'editorLineNumber.foreground': '#6272a4cc',
          'editorLineNumber.activeForeground': '#f8f8f2',
          'editor.selectionBackground': '#44475a',
          'editorCursor.foreground': '#f8f8f2',
          'editor.lineHighlightBorder': '#282a36',
          'editor.lineHighlightBackground': '#282a3644',
        }
      });
      if (inputContainerRef.current) {
        inputEditorRef.current = monaco.editor.create(inputContainerRef.current, {
          value: '',
          language: 'javascript',
          theme: 'dracula',
          automaticLayout: true,
          fontSize: 14,
          fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace",
          lineHeight: 21,
          minimap: { enabled: false },
          scrollBeyondLastLine: false,
          wordWrap: 'off',
          tabSize: 2,
          renderLineHighlight: 'all',
          overviewRulerLanes: 0,
          scrollbar: { useShadows: false },
          renderValidationDecorations: 'off',
        });
      }
      if (outputContainerRef.current) {
        outputEditorRef.current = monaco.editor.create(outputContainerRef.current, {
          value: '',
          language: 'javascript',
          theme: 'dracula',
          automaticLayout: true,
          fontSize: 14,
          fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace",
          lineHeight: 21,
          minimap: { enabled: false },
          scrollBeyondLastLine: false,
          wordWrap: 'on',
          tabSize: 2,
          renderLineHighlight: 'all',
          overviewRulerLanes: 0,
          readOnly: true,
          scrollbar: { useShadows: false },
          renderValidationDecorations: 'off',
        });
      }
      setMonacoReady(true);
    });
    return () => { if (inputEditorRef.current) inputEditorRef.current.dispose(); if (outputEditorRef.current) outputEditorRef.current.dispose(); };
  }, []);

  useEffect(() => { if (monacoReady && inputEditorRef.current) { monaco.editor.setModelLanguage(inputEditorRef.current.getModel(), language); if (outputEditorRef.current) monaco.editor.setModelLanguage(outputEditorRef.current.getModel(), language); } }, [language, monacoReady]);

  return <div style={{ width: '100%', maxWidth: '95%', margin: '40px auto', display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
    <div style={{ display: 'flex', gap: '25px', width: '100%', height: '75vh' }}>
      <div style={{ flex: 1, background: 'rgba(30, 30, 46, 0.85)', borderRadius: '8px', border: '1px solid #44475a', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
        <div style={{ padding: '10px 15px', borderBottom: '1px solid #44475a', color: '#bd93f9', fontSize: '14px' }}>Input</div>
        <div ref={inputContainerRef} style={{ flex: 1, overflow: 'hidden' }} className="monaco-editor-container" />
      </div>
      <div style={{ flex: 1, background: 'rgba(30, 30, 46, 0.85)', borderRadius: '8px', border: '1px solid #44475a', display: 'flex', flexDirection: 'column', overflow: 'hidden', position: 'relative' }}>
        <div style={{ position: 'relative', padding: '10px 15px', borderBottom: '1px solid #44475a', color: '#bd93f9', fontSize: '14px' }}>Output <button onClick={copyToClipboard} style={{ position: 'absolute', right: '10px', top: '7px', fontSize: '16px', padding: '2px 4px', backgroundColor: 'transparent', color: copySuccess ? '#50fa7b' : '#bd93f9', border: 'none', cursor: 'pointer' }}>{copySuccess ? '‚úì' : 'üìã'}</button></div>
        <div ref={outputContainerRef} style={{ flex: 1, overflow: 'hidden' }} className="monaco-editor-container" />
      </div>
    </div>
    <div style={{ padding: '20px 0', display: 'flex', justifyContent: 'center', gap: '15px', alignItems: 'center', flexWrap: 'wrap' }}>
      <select value={language} onChange={(e) => setLanguage(e.target.value)} style={{ backgroundColor: '#282a36', color: '#f8f8f2', border: '1px solid #44475a', borderRadius: '4px', padding: '8px 12px', outline: 'none', fontFamily: '"Tempus Sans ITC", sans-serif', fontSize: '18px', textShadow: '1px 1px 1px rgba(0, 0, 255, 1)' }}><option value="javascript" style={{ fontFamily: '"Tempus Sans ITC", sans-serif' }}>JavaScript</option><option value="graalscript" style={{ fontFamily: '"Tempus Sans ITC", sans-serif' }}>Graal Script</option></select>
      <div style={{ display: 'flex', gap: '12px', alignItems: 'center' }}>
        <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', fontFamily: '"Tempus Sans ITC", sans-serif', fontSize: '18px', textShadow: '1px 1px 1px rgba(0, 0, 255, 1)' }}><input type="checkbox" checked={stripComments} onChange={(e) => setStripComments(e.target.checked)} style={{ margin: 0, accentColor: '#40ff40' }} /> Strip Comments</label>
        <label style={{ display: 'flex', alignItems: 'center', gap: '4px', cursor: 'pointer', fontFamily: '"Tempus Sans ITC", sans-serif', fontSize: '18px', textShadow: '1px 1px 1px rgba(0, 0, 255, 1)' }}><input type="checkbox" checked={beautify} onChange={(e) => setBeautify(e.target.checked)} style={{ margin: 0, accentColor: '#40ff40' }} /> Beautify Code</label>
        <select value={indentSize} onChange={(e) => setIndentSize(e.target.value)} style={{ marginLeft: '4px', backgroundColor: '#282a36', color: '#f8f8f2', border: '1px solid #44475a', borderRadius: '4px', padding: '8px 12px', outline: 'none', fontFamily: '"Tempus Sans ITC", sans-serif', fontSize: '18px', textShadow: '1px 1px 1px rgba(0, 0, 255, 1)' }}><option value="2" style={{ fontFamily: '"Tempus Sans ITC", sans-serif' }}>2 Spaces</option><option value="4" style={{ fontFamily: '"Tempus Sans ITC", sans-serif' }}>4 Spaces</option><option value="tab" style={{ fontFamily: '"Tempus Sans ITC", sans-serif' }}>Tab</option></select>
      </div>
      <button onClick={processCode} style={{ backgroundColor: 'rgba(64, 255, 64, 0.3)', color: '#40ff40', border: '1px solid rgba(64, 255, 64, 0.3)', borderRadius: '4px', padding: '10px 20px', cursor: 'pointer', fontWeight: '500', fontFamily: '"Tempus Sans ITC", sans-serif', fontSize: '18px' }}>Process Code</button>
    </div>
  </div>;
}

function IndexingTutorial() {
  const [tutorial, setTutorial] = useState('photoshop');
  const [currentSlide, setCurrentSlide] = useState(0);
  const [viewAll, setViewAll] = useState(false);
  const content = tutorials[tutorial];
  const htmlContent = marked.parse(content);
  const sections = htmlContent.split(/(?=<h[234]>)/).filter(s => s.trim());

  useEffect(() => {
    const psImages = ['/gfx/pstutorial/bodytut1.PNG', '/gfx/pstutorial/bodytut2.PNG', '/gfx/pstutorial/bodytut3.PNG', '/gfx/pstutorial/bodytut4.PNG', '/gfx/pstutorial/bodytut5.PNG'];
    const gimpImages = ['/gfx/gimptutorial/image-2.webp', '/gfx/gimptutorial/image-3.webp', '/gfx/gimptutorial/image-4.webp', '/gfx/gimptutorial/image-5.webp', '/gfx/gimptutorial/image-6.webp', '/gfx/gimptutorial/image-8.webp', '/gfx/gimptutorial/image-9.webp', '/gfx/gimptutorial/image-11.png', '/gfx/gimptutorial/image-12.png', '/gfx/gimptutorial/image-13.png', '/gfx/gimptutorial/image-15.png', '/gfx/gimptutorial/image-16.png', '/gfx/gimptutorial/image-17.png', '/gfx/gimptutorial/image-20.png', '/gfx/gimptutorial/image-21.png', '/gfx/gimptutorial/image-22.png', '/gfx/gimptutorial/image-23.png', '/gfx/gimptutorial/image-24.png', '/gfx/gimptutorial/image-26.png', '/gfx/gimptutorial/image-27.png', '/gfx/gimptutorial/image-29.png', '/gfx/gimptutorial/image-30.png'];
    [...psImages, ...gimpImages].forEach(src => { const img = new Image(); img.src = src; });
  }, []);

  const nextSlide = () => { if (currentSlide < sections.length - 1) setCurrentSlide(currentSlide + 1); };
  const prevSlide = () => { if (currentSlide > 0) setCurrentSlide(currentSlide - 1); };
  const toggleViewAll = () => { setViewAll(!viewAll); };
  const switchTutorial = (tut) => { setTutorial(tut); setCurrentSlide(0); setViewAll(false); };

  return <div className="container" style={{ position: 'relative', marginTop: '20px', minHeight: 'auto', padding: '0' }}>
    <div className="content-wrapper">
      <div className="header">
        <div className="tutorial-toggle" style={{ display: 'flex', gap: '15px', justifyContent: 'center', marginBottom: '20px' }}>
          <button className={`toggle-btn ${tutorial === 'photoshop' ? 'active' : ''}`} onClick={() => switchTutorial('photoshop')} style={{ padding: '10px 20px', background: 'rgba(64,255,64,0.2)', color: '#40ff40', border: '1px solid rgba(64,255,64,0.3)', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '600', transition: 'all 0.2s' }}>Photoshop Tutorial</button>
          <button className={`toggle-btn ${tutorial === 'gimp' ? 'active' : ''}`} onClick={() => switchTutorial('gimp')} style={{ padding: '10px 20px', background: 'rgba(64,255,64,0.2)', color: '#40ff40', border: '1px solid rgba(64,255,64,0.3)', borderRadius: '8px', cursor: 'pointer', fontSize: '14px', fontWeight: '600', transition: 'all 0.2s' }}>GIMP Tutorial</button>
        </div>
        <p className="page-indicator">{viewAll ? 'Viewing all pages' : `Page ${currentSlide + 1} of ${sections.length}`}</p>
      </div>
      {!viewAll && <div className="nav-dots">{sections.map((_, i) => <div key={i} className={`nav-dot ${i === currentSlide ? 'active' : ''}`} onClick={() => setCurrentSlide(i)} />)}</div>}
      <div className={`content-box ${viewAll ? 'all-content' : ''}`}>
        {viewAll ? sections.map((section, i) => <div key={i} className="slide active"><div dangerouslySetInnerHTML={{ __html: section }} /></div>) : <div className="slide active"><div dangerouslySetInnerHTML={{ __html: sections[currentSlide] }} /></div>}
      </div>
      <div className="nav-buttons">
        {!viewAll && <button className="nav-btn" onClick={prevSlide} disabled={currentSlide === 0}>‚Üê Previous</button>}
        <button className="nav-btn view-all-btn" onClick={toggleViewAll}>{viewAll ? 'View Paged' : 'View All'}</button>
        {!viewAll && <button className="nav-btn" onClick={nextSlide} disabled={currentSlide === sections.length - 1}>Next ‚Üí</button>}
      </div>
      {tutorial === 'gimp' && <div className="credits"><a href="https://brydengfx.wordpress.com/how-to-index/" target="_blank" style={{ color: '#40ff40' }}>Source: brydengfx.wordpress.com</a></div>}
    </div>
  </div>;
}

function App() {
  const [fadeClass, setFadeClass] = useState('');
  const [showIndexing, setShowIndexing] = useState(() => new URLSearchParams(window.location.search).has('indexing'));
  const [showBeautify, setShowBeautify] = useState(() => new URLSearchParams(window.location.search).has('beautify'));

  const handleLinkClick = (e) => {
    const link = e.currentTarget;
    if (link.hostname !== window.location.hostname) {
      e.preventDefault();
      setTimeout(() => (window.location.href = link.href), 400);
    }
  };

  useEffect(() => {
    document.querySelectorAll('a[href^="http"]').forEach(link => {
      link.addEventListener('click', handleLinkClick);
    });
    return () => {
      document.querySelectorAll('a[href^="http"]').forEach(link => {
        link.removeEventListener('click', handleLinkClick);
      });
    };
  }, []);

  return (
    <div className={`container ${fadeClass}`}>
      {showIndexing ? <div style={{ position: 'fixed', top: '20px', left: '20px', zIndex: 1000 }}><a href="/" onClick={(e) => { e.preventDefault(); setShowIndexing(false); window.history.pushState(null, '', '/'); setTimeout(() => { if (typeof initMenus === 'function') initMenus(); }, 100); }} style={{ fontSize: '16px', color: '#40ff40', cursor: 'pointer' }}><i className="fas fa-arrow-left"></i> Back</a></div> : null}
      {showBeautify ? <div style={{ position: 'fixed', top: '20px', left: '20px', zIndex: 1000 }}><a href="/" onClick={(e) => { e.preventDefault(); setShowBeautify(false); window.history.pushState(null, '', '/'); setTimeout(() => { if (typeof initMenus === 'function') initMenus(); }, 100); }} style={{ fontSize: '16px', color: '#40ff40', cursor: 'pointer' }}><i className="fas fa-arrow-left"></i> Back</a></div> : null}
      {showIndexing ? <IndexingTutorial /> :
      showBeautify ? <BeautifyTool /> :
      <React.Fragment>
      <div className="links">
        <div className="dropdown">
          <span className="dropdown-btn">
            <i className="fas fa-book"></i>
            <span>Documentation</span>
          </span>
          <div className="dropdown-content">
            {data.documentation.map((item, idx) => (
              <ClickSpark key={idx} sparkColor="#40ff40" onClick={handleLinkClick}>
                <a href={item.href}>
                  <i className={item.icon}></i>
                  <span>{item.text}</span>
                </a>
              </ClickSpark>
            ))}
          </div>
        </div>

        <div className="dropdown">
          <span className="dropdown-btn">
            <i className="fas fa-tools"></i>
            <span>Tools</span>
          </span>
          <div className="dropdown-content">
            {data.tools.map((item, idx) => {
              if (item.submenu) {
                return (
                  <div key={idx} className="submenu">
                    <ClickSpark sparkColor="#40ff40">
                      <a>
                        <i className={item.icon}></i>
                        <span>{item.text}</span>
                        <i className="fas fa-chevron-right" style={{marginLeft: 'auto', fontSize: '0.8em', opacity: 0.7}}></i>
                      </a>
                    </ClickSpark>
                    <div className="submenu-content">
                      {item.submenu.map((sub, sidx) => (
                        <ClickSpark key={sidx} sparkColor="#40ff40" onClick={handleLinkClick}>
                          <a href={sub.href}>
                            <i className={sub.icon}></i>
                            <span>{sub.text}</span>
                          </a>
                        </ClickSpark>
                      ))}
                    </div>
                  </div>
                );
              }
              return (
                <ClickSpark key={idx} sparkColor="#40ff40" onClick={(e) => { if (item.href === '/?indexing') { e.preventDefault(); setShowIndexing(true); window.history.pushState(null, '', '/?indexing'); } else if (item.href === '/?beautify') { e.preventDefault(); setShowBeautify(true); window.history.pushState(null, '', '/?beautify'); } else { handleLinkClick(e); } }}>
                  <a href={item.href}>
                    <i className={item.icon}></i>
                    <span>{item.text}</span>
                  </a>
                </ClickSpark>
              );
            })}
          </div>
        </div>

        <div className="dropdown">
          <span className="dropdown-btn">
            <i className="fas fa-palette"></i>
            <span>Graphics Assets</span>
          </span>
          <div className="dropdown-content">
            {data.graphics.map((item, idx) => {
              if (item.submenu) {
                return (
                  <div key={idx} className="submenu">
                    <ClickSpark sparkColor="#40ff40">
                      <a>
                        <i className={item.icon}></i>
                        <span>{item.text}</span>
                        <i className="fas fa-chevron-right" style={{marginLeft: 'auto', fontSize: '0.8em', opacity: 0.7}}></i>
                      </a>
                    </ClickSpark>
                    <div className="submenu-content">
                      {item.submenu.map((sub, sidx) => (
                        <ClickSpark key={sidx} sparkColor="#40ff40" onClick={handleLinkClick}>
                          <a href={sub.href}>
                            <i className={sub.icon}></i>
                            <span>{sub.text}</span>
                          </a>
                        </ClickSpark>
                      ))}
                    </div>
                  </div>
                );
              }
              return (
                <ClickSpark key={idx} sparkColor="#40ff40" onClick={handleLinkClick}>
                  <a href={item.href}>
                    <i className={item.icon}></i>
                    <span>{item.text}</span>
                  </a>
                </ClickSpark>
              );
            })}
          </div>
        </div>

        <div className="dropdown">
          <a href="https://discord.gscript.dev" className="dropdown-btn">
            <i className="fab fa-discord"></i>
            <span>Discord</span>
          </a>
          <div className="dropdown-content discord-widget">
            <DiscordWidget />
          </div>
        </div>
      </div>

      <div className="character">
        <div className="character-img"></div>
      </div>

      <footer style={{ textAlign: 'center', color: '#ffffff', textShadow: '1px 1px 1px rgba(0, 0, 255, 1)', width: '100%', fontSize: '18px' }}>
        <p>
          <a href="https://graalonline.com" style={{ color: '#40ff40', textDecoration: 'none', textShadow: '2px 2px 4px rgba(0, 0, 0, 1)' }}>Graal Online</a> is Copyright/trademarked to <a href="https://www.toonslab.com/" style={{ color: '#40ff40', textDecoration: 'none', textShadow: '2px 2px 4px rgba(0, 0, 0, 1)' }}>Toonslab</a> and is in no way affiliated with this site.
        </p>
      </footer>
      </React.Fragment>
      }
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'), () => {
  if (typeof initMenus === 'function') initMenus();
});
</script>

<script>
const initMenus = () => {
  const { computePosition, flip, shift, offset, autoUpdate } = window.FloatingUIDOM || {};
  const cleanups = new Map();

  const cleanup = (id) => {
    if (cleanups.has(id)) {
      cleanups.get(id)();
      cleanups.delete(id);
    }
  };

  const closeAll = (except = null) => {
    document.querySelectorAll('.dropdown').forEach(d => {
      if (d === except) return;
      const id = d.dataset.id;
      cleanup(id);
      const content = d.querySelector('.dropdown-content');
      const btn = d.querySelector('.dropdown-btn');
      if (content) content.style.display = 'none';
      if (btn) btn.classList.remove('active');
      d.querySelectorAll('.submenu-content').forEach(s => s.style.display = 'none');
    });
  };

  document.querySelectorAll('.dropdown').forEach((dropdown, i) => {
    const id = `drop-${i}`;
    dropdown.dataset.id = id;
    const content = dropdown.querySelector('.dropdown-content');
    const btn = dropdown.querySelector('.dropdown-btn');
    let timer;

    const position = () => {
      if (!content || content.style.display === 'none') return;
      const clean = autoUpdate(dropdown, content, () => {
        computePosition(dropdown, content, {
          placement: 'bottom-start',
          middleware: [offset(8), flip(), shift({ padding: 10 }), {
            name: 'preventOverflow',
            fn({ middlewareData, ...args }) {
              const floating = args.floating;
              if (!floating) return {};

              const rect = floating.getBoundingClientRect();
              const windowHeight = window.innerHeight;
              const overflowBottom = rect.bottom - windowHeight;

              if (overflowBottom > 0) {
                return {
                  y: (args.y || 0) - overflowBottom - 10
                };
              }

              return {};
            }
          }]
        }).then(({ x, y }) => {
          content.style.left = `${x}px`;
          content.style.top = `${y}px`;
        });
      });
      cleanups.set(id, clean);
    };

    const hasSubmenuHover = () => Array.from(dropdown.querySelectorAll('.submenu-content')).some(s => s.style.display === 'block' && s.matches(':hover'));

    const keepVisible = () => {
      clearTimeout(timer);
      if (content) content.style.display = 'block';
      if (btn) btn.classList.add('active');
    };

    dropdown.addEventListener('mouseenter', () => {
      clearTimeout(timer);
      closeAll(dropdown);
      if (content) {
        content.style.display = 'block';
        position();
      }
      if (btn) btn.classList.add('active');
    });

    dropdown.addEventListener('mouseleave', (e) => {
      if (e.relatedTarget && (content?.contains(e.relatedTarget) || hasSubmenuHover())) return;
      timer = setTimeout(() => {
        if (!content?.matches(':hover') && !hasSubmenuHover()) {
          if (content) content.style.display = 'none';
          if (btn) btn.classList.remove('active');
          dropdown.querySelectorAll('.submenu-content').forEach(s => s.style.display = 'none');
          cleanup(id);
        }
      }, 300);
    });

    if (content) {
      content.addEventListener('mouseenter', keepVisible);
      content.addEventListener('mouseleave', (e) => {
        const movingToSubmenu = e.relatedTarget && Array.from(dropdown.querySelectorAll('.submenu-content')).some(s => s === e.relatedTarget || s.contains(e.relatedTarget));
        if (movingToSubmenu) return;
        timer = setTimeout(() => {
          if (!dropdown.matches(':hover') && !hasSubmenuHover()) {
            content.style.display = 'none';
            if (btn) btn.classList.remove('active');
            cleanup(id);
          }
        }, 300);
      });
    }

    dropdown.querySelectorAll('.submenu').forEach(submenu => {
      const link = submenu.querySelector('a');
      const sub = submenu.querySelector('.submenu-content');
      if (!link || !sub) return;

      link.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropdown.querySelectorAll('.submenu-content').forEach(s => {
          if (s !== sub) {
            s.classList.remove('slide-down');
            s.classList.add('slide-up');
            setTimeout(() => {
              s.style.display = 'none';
              s.classList.remove('slide-up');
            }, 200);
          }
        });
        if (sub.style.display === 'block') {
          sub.classList.remove('slide-down');
          sub.classList.add('slide-up');
          setTimeout(() => {
            sub.style.display = 'none';
            sub.classList.remove('slide-up');
          }, 200);
        } else {
          sub.style.display = 'block';
          sub.classList.remove('slide-up');
          void sub.offsetWidth;
          sub.classList.add('slide-down');
        }
        keepVisible();
      });

      link.addEventListener('mouseenter', () => {
        clearTimeout(timer);
        keepVisible();
      });
    });
  });
};

window.addEventListener('pageshow', (e) => {
  if (e.persisted) initMenus();
});

initMenus();
</script>
</body>
</html>
